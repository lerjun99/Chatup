@page "/users"
@inject HttpClient Http
@inject IJSRuntime JS
@using System.Net.Http.Json
@using ChatUp.Application.Features.User.DTOs
@using ChatUp.Application.Features.UserRegistration.DTOs
@using ChatUp.Services
@inject NavigationManager Navigation
<h3 class="mb-3">👥 User Management</h3>
@inject ChatUp.Services.LinkService LinkService
@inject ChatUp.Services.EmailService EmailService
@inject IDialogService DialogService
@if (isSendingEmail)
{
    <div class="email-overlay">
        <div class="email-spinner">
            <img src="images/email-sendings.gif" alt="Sending Email..." class="email-gif" />
            <p>Sending emails... Please wait</p>
        </div>
    </div>
}
<div class="flex-grow-1 p-3 p-md-4 bg-light" style="margin-bottom:50px">
    <div class="toolbar-container d-flex flex-wrap gap-2 mb-3 justify-content-between align-items-center">
        <div class="action-toolbar d-flex flex-wrap align-items-center gap-2">
            <input class="form-control search-box"
                   placeholder="🔍 Search by name or username"
                   @bind="searchTerm" @bind:event="oninput" />

            <button class="btn btn-primary action-btn" @onclick="FilterUsers">
                <i class="fa-solid fa-magnifying-glass"></i> <span class="btn-text">Search</span>
            </button>

            <button class="btn btn-success action-btn" @onclick="ImportUsers">
                <i class="fa-solid fa-upload"></i> <span class="btn-text">Import</span>
            </button>

            <button class="btn btn-secondary action-btn" @onclick="ExportUsers">
                <i class="fa-solid fa-download"></i> <span class="btn-text">Export</span>
            </button>

            <button class="btn btn-outline-danger action-btn"
                    disabled="@(!selectedUsers.Any())" @onclick="BulkDelete">
                <i class="fa-solid fa-trash"></i> <span class="btn-text">Delete</span>
            </button>

            <button class="btn btn-outline-info action-btn"
                    disabled="@(!selectedUsers.Any())" @onclick="BulkSendEmail">
                <i class="fa-solid fa-envelope"></i> <span class="btn-text">Email</span>
            </button>
        </div>

        <button class="btn btn-primary rounded-pill px-3 register-btn" @onclick="RegisterUser">
            <i class="fa-solid fa-user-plus"></i> <span class="btn-text">Register New</span>
        </button>
    </div>

    @if (isLoading)
    {
        <div class="loading-section">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
        </div>
    }
    else
    {
        <div class="table-wrapper">
            <div class="table-responsive scrollable-table">
                <table class="table table-hover align-middle user-table">
                    <thead>
                        <tr>
                            <th><input type="checkbox" @onchange="SelectAllChanged" checked="@selectAll" /></th>
                            <th>Avatar</th>
                            <th>Username</th>
                            <th>Full Name</th>
                            <th>Email</th>
                            <th>Status</th>
                            <th>Online</th>
                            <th>Last Login</th>
                            <th class="sticky-actions">Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        @if (filteredUsers is not null && filteredUsers.Any())
                        {
                            @foreach (var user in pagedUsers)
                            {
                                <tr>
                                    <td><input type="checkbox" value="@user.Id" @onchange="() => ToggleUserSelection(user.Id)" checked="@selectedUsers.Contains(user.Id)" /></td>
                                    <td><img src="@GetAvatar(user)" width="40" height="40" class="rounded-circle border" /></td>
                                    <td>@user.Username</td>
                                    <td>@user.FullName</td>
                                    <td>@(string.IsNullOrEmpty(user.EmailAddress) ? "-" : user.EmailAddress)</td>
                                    <td>
                                        <span class="badge @(user.IsActive ? "bg-success" : "bg-danger")">
                                            @(user.IsActive ? "Active" : "Inactive")
                                        </span>
                                    </td>
                                    <td>
                                        <span class="badge @(user.IsOnline ? "bg-success" : "bg-secondary")">
                                            @(user.IsOnline ? "Online" : "Offline")
                                        </span>
                                    </td>
                                    <td>@(user.LastLoginTime?.ToString("MMM dd, yyyy HH:mm") ?? "-")</td>
                                    <td class="sticky-actions">
                                        <div class="action-buttons">
                                            <button class="btn btn-sm btn-primary rounded-pill px-3" @onclick="() => EditUser(user.Id)">
                                                <i class="fa-solid fa-pencil"></i> Edit
                                            </button>
                                            <button class="btn btn-sm btn-danger rounded-pill px-3" @onclick="() => DeleteUser(user.Id)">
                                                <i class="fa-solid fa-trash"></i> Delete
                                            </button>
                                            <button class="btn btn-sm btn-info rounded-pill px-3" @onclick="() => SendEmail(user.Id)">
                                                <i class="fa-solid fa-envelope"></i> Email
                                            </button>
                                        </div>
                                    </td>
                                </tr>
                            }
                        }
                        else
                        {
                            <tr>
                                <td colspan="9" class="text-center text-muted py-4">No users found</td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>

            @if (filteredUsers.Any())
            {
                <div class="pagination-holder">
                    <div>
                        <span>Showing @FromPage to @ToPage of @filteredUsers.Count entries</span>
                    </div>
                    <div class="pagination-button-holder">
                        <button class="btn btn-secondary" @onclick="PreviousPage" disabled="@(!CanGoPrev)"><i class="fa-solid fa-backward"></i></button>
                        @for (int i = 1; i <= TotalPage; i++)
                        {
                            int page = i;
                            <input type="button" value=@(page)
                                   class="@(CurrentPage == page ? "active" : "")"
                                   @onclick="() => SelectedPage(page)" />
                        }
                        <button class="btn btn-secondary" @onclick="NextPage" disabled="@(!CanGoNext)"><i class="fa-solid fa-forward"></i></button>
                    </div>
                </div>
            }
        </div>
    }
</div>

@if (ShowModal)
{
    <div class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header">
                <h4>📧 Bulk Email Summary</h4>
            </div>

            <div class="modal-body">
                <p><b>✅ Successfully sent:</b> @Summary.Sent</p>
                <p><b>⚠️ Skipped (Invalid Status):</b> @Summary.Skipped</p>
                <p><b>❌ Failed to send:</b> @Summary.Failed</p>
            </div>

            <div class="modal-footer">
                <button class="btn-close" @onclick="CloseModal"></button>
            </div>
        </div>
    </div>
}
@code {
    private bool ShowModal = false;

    private (int Sent, int Skipped, int Failed) Summary;
    private bool isLoading = true;
    private bool isSendingEmail = false;
    private List<UserDetailsDto> users = new();
    private List<UserDetailsDto> filteredUsers = new();
    private List<UserDetailsDto> pagedUsers = new();
    private List<int> selectedUsers = new();
    private string searchTerm = string.Empty;
    private bool selectAll = false;
    [Parameter] public EventCallback OnNavigate { get; set; }
    @inject NavigationManager Nav
    private int CurrentPage = 1;
    private int PageSize = 10;
    private int TotalPage => (int)Math.Ceiling((double)filteredUsers.Count / PageSize);
    private bool CanGoNext => CurrentPage < TotalPage;
    private bool CanGoPrev => CurrentPage > 1;
    private int FromPage => ((CurrentPage - 1) * PageSize) + 1;
    private int ToPage => Math.Min(CurrentPage * PageSize, filteredUsers.Count);
    protected override async Task OnInitializedAsync()
    {
        await LoadUsers();
        ApplyPagination();
    }

    private async Task LoadUsers()
    {
        try
        {
            var url = Navigation.ToAbsoluteUri($"{AppConfig.ChatUrl}User/GetAllUsers").ToString();
            var response = await Http.GetAsync(url);
            if (response.IsSuccessStatusCode)
            {
                var json = await response.Content.ReadAsStringAsync();
                users = JsonSerializer.Deserialize<List<UserDetailsDto>>(json, new JsonSerializerOptions { PropertyNameCaseInsensitive = true }) ?? new();
                filteredUsers = users;
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine(ex.Message);
        }
        finally
        {
            isLoading = false;
        }
    }

    private void ApplyPagination()
    {
        pagedUsers = filteredUsers.Skip((CurrentPage - 1) * PageSize).Take(PageSize).ToList();
    }

    private void SelectedPage(int page)
    {
        CurrentPage = page;
        ApplyPagination();
    }

    private void NextPage()
    {
        if (CanGoNext)
        {
            CurrentPage++;
            ApplyPagination();
        }
    }

    private void PreviousPage()
    {
        if (CanGoPrev)
        {
            CurrentPage--;
            ApplyPagination();
        }
    }

    private void FilterUsers()
    {
        if (string.IsNullOrWhiteSpace(searchTerm))
            filteredUsers = users;
        else
            filteredUsers = users
                .Where(u => (u.FullName ?? "").Contains(searchTerm, StringComparison.OrdinalIgnoreCase)
                         || (u.Username ?? "").Contains(searchTerm, StringComparison.OrdinalIgnoreCase))
                .ToList();

        CurrentPage = 1;
        ApplyPagination();
    }
    private void ToggleUserSelection(int userId)
    {
        if (selectedUsers.Contains(userId))
            selectedUsers.Remove(userId);
        else
            selectedUsers.Add(userId);
    }

    private void SelectAllChanged(ChangeEventArgs e)
    {
        selectAll = (bool)e.Value;
        if (selectAll)
            selectedUsers = filteredUsers.Select(u => u.Id).ToList();
        else
            selectedUsers.Clear();
    }

    // private void RegisterUser() => JS.InvokeVoidAsync("alert", "Navigate to registration form...");
    private void RegisterUser()
    {
        var token = LinkService.Protect("new"); // 🔐 Encrypt "new" as identifier
        var encodedToken = Uri.EscapeDataString(token);
        Navigate($"/user-registers/{encodedToken}");
    }
    // private void EditUser(int id) => JS.InvokeVoidAsync("alert", $"Edit user {id}");
    // private void DeleteUser(int id) => JS.InvokeVoidAsync("alert", $"Delete user {id}");
    // private void SendEmail(int id) => JS.InvokeVoidAsync("alert", $"Send email to user {id}");

    // private void BulkDelete() => JS.InvokeVoidAsync("alert", $"Deleting {selectedUsers.Count} users...");
    // private void BulkSendEmail() => JS.InvokeVoidAsync("alert", $"Sending email to {selectedUsers.Count} users...");
    private async Task DeleteUser(int id, bool showMessage = true)
    {
        if (showMessage)
        {
            var confirmDialog = await DialogService.ShowConfirmationAsync("Confirm Delete", "Are you sure you want to delete this user?");
            var result = await confirmDialog.Result;
            if (result.Cancelled) return;
        }

        try
        {
            var url = $"{AppConfig.ChatUrl}User/DeleteUser/delete/{id}";
            var response = await Http.DeleteAsync(url);

            if (response.IsSuccessStatusCode)
            {
                  if (showMessage)
                  {
                       await DialogService.ShowSuccessAsync("User deleted successfully!");
                  }
               
                await LoadUsers();
                ApplyPagination();
            }
            else
            {
                var msg = await response.Content.ReadAsStringAsync();
                await DialogService.ShowErrorAsync($"Failed to delete user: {msg}");
            }
        }
        catch (Exception ex)
        {
            await DialogService.ShowErrorAsync($"Error deleting user: {ex.Message}");
        }
    }

    private async Task SendEmail(int id)
    {
        try
        {
            isSendingEmail = true;
            StateHasChanged();

            var response = await Http.PostAsJsonAsync($"{AppConfig.ChatUrl}User/ApproveUser/Approve", new { UserId = id });

            if (response.IsSuccessStatusCode)
            {
                var result = await response.Content.ReadFromJsonAsync<ChangePasswordResponseDto>();
                await DialogService.ShowSuccessAsync($"{result?.Message}");
            }
            else
            {
                var error = await response.Content.ReadAsStringAsync();
                await DialogService.ShowErrorAsync($"❌ Approval failed: {error}");
            }
        }
        catch (Exception ex)
        {
            await DialogService.ShowErrorAsync($"Error: {ex.Message}");
        }
        finally
        {
            isSendingEmail = false;
            StateHasChanged();
        }
    }

    private async Task BulkDelete()
    {
        if (!selectedUsers.Any())
        {
            var dialog = await DialogService.ShowWarningAsync("No users selected for deletion.");
            await dialog.Result;
            return;
        }

        // ✅ Ask for confirmation properly
        var confirmDialog = await DialogService.ShowConfirmationAsync(
            "Are you sure you want to delete ",
            $"{selectedUsers.Count} selected users?"
        );

        var confirmResult = await confirmDialog.Result;
        if (confirmResult.Cancelled)
            return;

        // ✅ Proceed with deletion
        foreach (var userId in selectedUsers)
        {
            await DeleteUser(userId, showMessage: false);
        }

        await LoadUsers();
        ApplyPagination();
        StateHasChanged();

        // ✅ Show success message
        var successDialog = await DialogService.ShowSuccessAsync($"{selectedUsers.Count} users deleted successfully!");
        await successDialog.Result;

        selectedUsers.Clear();
        selectAll = false;
    }

    private async Task BulkSendEmail()
    {
        if (!selectedUsers.Any())
        {
            await DialogService.ShowWarningAsync("No users selected for email sending.");
            return;
        }

        var confirmDialog = await DialogService.ShowConfirmationAsync(
            "Confirm Send emails to",
            $" {selectedUsers.Count} selected users?"
        );

        var confirmResult = await confirmDialog.Result;
        if (confirmResult.Cancelled)
            return;

        int sent = 0;
        int skipped = 0;
        int failed = 0;

        try
        {
            isSendingEmail = true;
            StateHasChanged();

            foreach (var id in selectedUsers)
            {
                var user = users.FirstOrDefault(u => u.Id == id);
                if (user == null || user.Status != 2 || string.IsNullOrWhiteSpace(user.EmailAddress))
                {
                    skipped++;
                    continue;
                }

                try
                {
                    // Call API to approve user and send email
                    var response = await Http.PostAsJsonAsync(
                        $"{AppConfig.ChatUrl}User/ApproveUser/Approve",
                        new { UserId = id }
                    );

                    if (response.IsSuccessStatusCode)
                    {
                        var result = await response.Content.ReadFromJsonAsync<ChangePasswordResponseDto>();
                        if (result?.IsSuccess == true)
                            sent++;
                        else
                            failed++;
                    }
                    else
                    {
                        failed++;
                    }
                }
                catch
                {
                    failed++;
                }
            }

            // ✅ Summary Message
            Summary = (sent, skipped, failed);
            ShowModal = true;
        }
        finally
        {
            isSendingEmail = false;
            StateHasChanged();
        }
    }

    private void CloseModal() => ShowModal = false;
    private void EditUser(int id)
    {
        // 🔐 Encrypt user ID
        var token = LinkService.Protect(id.ToString());
        var encodedToken = Uri.EscapeDataString(token);
        Navigate($"/user-registers/{encodedToken}");

    }
    private void Navigate(string url)
    {
        Nav.NavigateTo(url, forceLoad: false);
        if (OnNavigate.HasDelegate)
            OnNavigate.InvokeAsync();
    }
    private async Task ImportUsers()
    {
        await JS.InvokeVoidAsync("alert", "Import functionality coming soon...");
    }

    private async Task ExportUsers()
    {
        var csv = new StringBuilder();
        csv.AppendLine("Id,Username,FullName,Email,IsActive,IsOnline,LastLoginTime");
        foreach (var u in filteredUsers)
        {
            csv.AppendLine($"{u.Id},{u.Username},{u.FullName},{u.EmailAddress},{u.IsActive},{u.IsOnline},{u.LastLoginTime}");
        }

        await JS.InvokeVoidAsync("downloadFile", "users.csv", "text/csv", csv.ToString());
    }

    private string GetAvatar(UserDetailsDto user)
        => user.UploadedFiles != null && user.UploadedFiles.Any()
            ? user.UploadedFiles.First().Base64Content // or FilePath
            : "images/default.png";
}