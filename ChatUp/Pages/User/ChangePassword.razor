@page "/change-password/{EncryptedId}"
@layout LoginLayout
@using ChatUp.Application.Features.EmailOTP.Commands
@using ChatUp.Application.Features.UserRegistration.DTOs
@using ChatUp.Services
@inject HttpClient Http
@inject NavigationManager Navigation
@inject IJSRuntime JS
@inject LinkService LinkService
@inject PasswordRecoveryService PasswordService
@inject Blazored.SessionStorage.ISessionStorageService SessionStorage
@inject Blazored.LocalStorage.ILocalStorageService LocalStorage
<EditForm Model="@changePasswordModel" OnValidSubmit="HandleSubmit">
    <DataAnnotationsValidator />
    <ValidationSummary />

    <div class="login-container">
        <div class="login-box">
            <h2>Change Password 🔐</h2>

            @if (IsOtpReset)
            {
                <p class="subtitle">Reset password for <strong>@Email</strong></p>
            }
            else
            {
                <p class="subtitle">Please update your password to continue</p>
            }

            @if (!IsOtpReset)
            {
                <div class="form-group">
                    <label>Current Password</label>
                    <div class="password-wrapper">
                        <InputText type="@oldPasswordType" @bind-Value="changePasswordModel.CurrentPassword" class="form-control" />
                        <button type="button" class="toggle-password" @onclick="ToggleOldPassword">
                            @(oldPasswordType == "password" ? "👁️" : "🙈")
                        </button>
                    </div>
                    <ValidationMessage For="@(() => changePasswordModel.CurrentPassword)" />
                </div>
            }

            <div class="form-group">
                <label>New Password</label>
                <div class="password-wrapper">
                    <InputText type="@newPasswordType" @bind-Value="newPassword" class="form-control" />
                    <button type="button" class="toggle-password" @onclick="ToggleNewPassword">
                        @(newPasswordType == "password" ? "👁️" : "🙈")
                    </button>
                </div>
            </div>

            <div class="form-group">
                <label>Confirm New Password</label>
                <div class="password-wrapper">
                    <InputText type="@confirmPasswordType" @bind-Value="confirmPassword" class="form-control" />
                    <button type="button" class="toggle-password" @onclick="ToggleConfirmPassword">
                        @(confirmPasswordType == "password" ? "👁️" : "🙈")
                    </button>
                </div>
            </div>

            @if (!string.IsNullOrEmpty(errorMessage))
            {
                <p class="error">@errorMessage</p>
            }

            <button type="submit" class="btn-login">Update Password</button>

            <div class="support">
                <NavLink href="#" class="sidebar-link nav-link" Match="NavLinkMatch.Prefix" @onclick="NavigateLogIn">
                    <span>Go back to login</span>
                </NavLink>
            </div>
        </div>
    </div>
</EditForm>

@code {
    [Parameter] public string EncryptedId { get; set; }

    private ChangePasswordDto changePasswordModel = new();
    private string newPassword = string.Empty;
    private string confirmPassword = string.Empty;
    private string errorMessage = string.Empty;

    private string oldPasswordType = "password";
    private string newPasswordType = "password";
    private string confirmPasswordType = "password";

    private int UserId;
    private string Email = string.Empty;
    private string? DecryptedIdOrEmail; // will store either decrypted user ID or email
    private bool IsOtpReset; // true if OTP reset (email), false if normal encrypted ID

    private void ToggleOldPassword() => oldPasswordType = oldPasswordType == "password" ? "text" : "password";
    private void ToggleNewPassword() => newPasswordType = newPasswordType == "password" ? "text" : "password";
    private void ToggleConfirmPassword() => confirmPasswordType = confirmPasswordType == "password" ? "text" : "password";

    private void NavigateLogIn() => Navigation.NavigateTo("/login", true);

    protected override async Task OnInitializedAsync()
    {
        if (IsValidEmail(EncryptedId))
        {
            // It's an email → OTP reset flow
            Email = EncryptedId;
            DecryptedIdOrEmail = Email;
            IsOtpReset = true;
        }
        else
        {
            // It's an encrypted value → decrypt it
            var decrypted = LinkService.Unprotect(Uri.UnescapeDataString(EncryptedId));
            if (!string.IsNullOrEmpty(decrypted) && int.TryParse(decrypted, out var id))
            {
                UserId = id;
                DecryptedIdOrEmail = decrypted;
                IsOtpReset = false;
            }
            else
            {
                // Invalid token
                errorMessage = "Invalid password change link.";
            }
        }
    }
    private bool IsValidEmail(string input)
    {
        try
        {
            var addr = new System.Net.Mail.MailAddress(input);
            return addr.Address == input;
        }
        catch
        {
            return false;
        }
    }
    private async Task HandleSubmit()
    {

        errorMessage = string.Empty;

        if (string.IsNullOrWhiteSpace(newPassword) || string.IsNullOrWhiteSpace(confirmPassword))
        {
            errorMessage = "All fields are required.";
            return;
        }

        if (newPassword != confirmPassword)
        {
            errorMessage = "New passwords do not match.";
            return;
        }

        try
        {
            if (IsOtpReset)
            {
                // OTP reset flow: use email & new password
                var resetCommand = new ChangeLogPasswordCommand
                {
                    Email = Email,
                    NewPassword = newPassword
                };
                var success = await PasswordService.ChangePasswordAsync(resetCommand);

                if (success)
                {
                    await JS.InvokeVoidAsync("alert", "✅ Password changed successfully!");
                    await JS.InvokeVoidAsync("sessionStorage.clear");
                    await JS.InvokeVoidAsync("localStorage.clear");
                    Navigation.NavigateTo("/login", true);
                }
                else
                {
                    errorMessage = "❌ Failed to change password.";
                }
            }
            else
            {
                // Normal flow: use userId & current password
                changePasswordModel.NewPassword = newPassword;
                changePasswordModel.UserId = UserId;
                var response = await Http.PostAsJsonAsync(AppConfig.ChatUrl + "User/ChangePassword/change-password", changePasswordModel);

                if (response.IsSuccessStatusCode)
                {
                    await JS.InvokeVoidAsync("alert", "✅ Password changed successfully!");
                    await JS.InvokeVoidAsync("sessionStorage.clear");
                    await JS.InvokeVoidAsync("localStorage.clear");
                    SessionStorage.SetItemAsync("runInboxIntro", "true");
                    Navigation.NavigateTo("/login", true);
                }
                else
                {
                    errorMessage = "❌ Failed to change password.";
                }
            }
        }
        catch (Exception ex)
        {
            errorMessage = $"⚠️ Error: {ex.Message}";
        }
    }
}
